<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <script src="lib.js"></script>
  <script>
    let id = 0;
    let selection; 

    async function populate_compat() {
      for (selection of document.getElementsByName("compat_tool")) {
        let tools = await getJSONAsync("/api/compat_tools")
        for (tool of tools) {
          const option = document.createElement('option');
          option.value = tool.id;
          option.textContent = tool.name;
          selection.appendChild(option);
        }
      }
      load_transition();
    }

    function add_subgame() {
      let subgame_area = document.getElementById("subgames");
      let subgame_elements = document.getElementsByName('subgame_meta');
      let subgame_dummy = document.getElementById("subgame_dummy").cloneNode(true);
      subgame_dummy.children[0].innerHTML="<b>Sub-Game " + (subgame_elements.length-1) + "</b>";
      subgame_dummy.style = "";
      subgame_dummy.name = "subgame_meta";
      subgame_dummy.id = "";
      subgame_area.appendChild(subgame_dummy);
    }

    function remove_subgame(button) {
      button.parentElement.remove()
    }
    
    async function submit() {
      let game_json = JSON.stringify({
        id: 0,
        name: document.getElementById('game_name').value
      });
      console.log(game_json);
      let parent_obj = await postJSON("/api/games", game_json);
      for (subgame_el of [... document.getElementsByClassName("subgame")].slice(1)) {
        var subgame_playtime = subgame_el.querySelector("[name='subgame_playtime']").valueAsNumber; 
        var subgame_json = JSON.stringify({
          id: 0,
          name: subgame_el.querySelector("[name='subgame_name']").value,
          playtime: subgame_playtime === 0 ? null : subgame_playtime,
          last_launch: null,
          is_archived: false,
          parent: parent_obj.id
        });
        console.log(subgame_json);
        let created_obj = await postJSON("/api/subgame", subgame_json);
        
        var gameconfig_json = JSON.stringify({
          arguments: subgame_el.querySelector("[name='launch_args']").value.split(" "),
          working_directory: subgame_el.querySelector("[name='workdir']").value,
          game_prefix: subgame_el.querySelector("[name='winprefix']").value,
          executable: subgame_el.querySelector("[name='gamex']").value,
          environment: toHashMap(subgame_el.querySelector("[name='env']").value),
          archive_file: ""
        });
        console.log(gameconfig_json);
        await postJSON(`/api/launch_config?id=${created_obj.id}`, gameconfig_json);
        var cover = subgame_el.querySelector("[name='sgcard']").files[0];
        await postImage(`/api/subgame_cover?id=${created_obj.id}`,cover);
        var compat_tool = subgame_el.querySelector("[name='compat_tool']").value;
        if (compat_tool != ""){
          await fetch(`/api/compat_assign?tool=${compat_tool}&game=${created_obj.id}`, {method: "GET"});
        }  
      }
      var card = document.getElementsByName("gamecard")[0].files[0];
      var background = document.getElementsByName("background")[0].files[0];
      await postImage(`/api/media?game=${parent_obj.id}&location=card`,card);
      await postImage(`/api/media?game=${parent_obj.id}&location=background`,background);

      }

    function onload() {
      id = parseIdFromUrl();
      if (id){
        document.body.style.backgroundImage="url(/api/media?game="+id+"&location=background)";
      }
      populate_compat()
    }
  </script>
</head>
<body onload="onload()">
 <div id="fade-overlay"></div> 
    <div class="blur_layer">
      <div class="flex_center">
        <div class = "center_popup">
          <h2 style="margin-bottom: 2rem;">Add Game:</h2>
          <span>Game Name:</span>
          <input type="text" name="name" id="game_name" placeholder="Some Game">
          <span>Game Card (600x900) (5 MB max):</span>
          <input type="file" name="gamecard" value="">
          <span>Game Background (5 MB max):</span>
          <input type="file" name="background" value="" style="margin-bottom: 3em">
          <span>Sub-Games:</span>
          <div class="subgames scrollable" id="subgames" style="text-align:left; padding: 1%">
            <div id="subgame_dummy" class="subgame" name="subgame_meta" style="display:none">
              <span><b>Sub-Game 0</b></span><br><br>
              <span>Sub-Game Name:</span>
              <input type="text" name="subgame_name" id="subgame0_name" placeholder="[leave empty for same]">
              <span>Sub-Game Card:</span>
              <input type="file" name="sgcard" value="">
              <span>Sub-Game Playtime (hours):</span>
              <input type="number" name="subgame_playtime" id="subgame0_playtime" value=0.0 step=0.1>
              <span>Compatability Tool:</span>
              <select name="compat_tool"></select>
              <span>Working Directory:</span>
              <input type="text" name="workdir" value="">
              <span>Wine Prefix:</span>
              <input type="text" name="winprefix" value="">
              <span>Game Executeable:</span>
              <input type="text" name="gamex" value="">
              <span>Launch Arguments:</span>
              <input type="text" name="launch_args" value="">
              <span>Environment:</span><br>
              <input type="text" name="env" value="" placeholder="SOME_VARIABLE,some value;SOME_OTHER_VAR,some value">
              <div class="button red" onclick="remove_subgame(this)">
                - Remove
              </div>
            </div>
            <div name="subgame_meta" class="subgame">
              <span><b>Sub-Game 0</b></span><br><br>
              <span>Sub-Game Name:</span>
              <input type="text" name="subgame_name" id="subgame0_name" placeholder="[leave empty for same]">
              <span>Sub-Game Card:</span>
              <input type="file" name="sgcard" value="">
              <span>Sub-Game Playtime (hours):</span>
              <input type="number" name="subgame_playtime" id="subgame0_playtime" value=0.0 step=0.1>
              <span>Compatability Tool:</span>
              <select name="compat_tool"></select>
              <span>Working Directory:</span>
              <input type="text" name="workdir" value="">
              <span>Wine Prefix:</span>
              <input type="text" name="winprefix" value="">
              <span>Game Executeable:</span>
              <input type="text" name="gamex" value="">
              <span>Launch Arguments:</span>
              <input type="text" name="launch_args" value="">
              <span>Environment:</span><br>
              <input type="text" name="env" value="" placeholder="SOME_VARIABLE,some value;SOME_OTHER_VAR,some value">
            </div>
          </div>
          <div class="button" onclick="add_subgame()">
          + Add Sub-Game
          </div>
          <div class="button green" onclick="submit()">
            Finish
          </div>
        </div>
      </div>
    </div>
</body>
</html>
